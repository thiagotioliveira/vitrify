<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${business.name}">Business Showcase</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body {
            background-color: [[${business.backgroundColor}]]; /* fundo */
            color: [[${business.fontColor}]];                 /* cor da fonte */
        }

        /* Header */
        header {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            padding: 1rem 0;
            background-color: [[${business.headerColor}]];    /* fundo do header */
            color: [[${business.fontColor}]];                /* cor do texto */
            border-bottom: 1px solid #dee2e6;
        }

        header img { height: 60px; object-fit: contain; }

        .header-controls {
            position: absolute;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            right: -320px;
            width: 300px;
            height: 100%;
            background: [[${business.headerColor}]];         /* fundo da sidebar */
            color: [[${business.fontColor}]];               /* cor do texto */
            box-shadow: -2px 0 6px rgba(0,0,0,0.1);
            transition: right 0.3s ease;
            z-index: 1050;
            overflow-y: auto;
        }

        .sidebar.open { right: 0; }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #dee2e6;
        }

        .sidebar-body { padding: 1rem; }

        .catalog-card { cursor: pointer; }
        .catalog-card img { object-fit: cover; height: 200px; width: 100%; }

        /* Links e ícones */
        a {
            color: [[${business.fontColor}]];
        }
    </style>
</head>
<body>

<!-- HEADER -->
<header>
    <!--<img id="businessLogo" src="https://placehold.co/200x60?text=200x60" alt="Business Logo">-->
    <img id="businessLogo" th:src="@{/img/logo.png}" th:alt="'Business Logo'" width="200" height="60">
    <div class="header-controls">
        <select id="languageSelect" class="form-select w-auto" onchange="changeLanguage()"></select>
        <i class="bi bi-list fs-2" role="button" onclick="toggleSidebar(true)"></i>
    </div>
</header>

<!-- SIDEBAR -->
<aside id="sidebar" class="sidebar">
    <div class="sidebar-header">
        <h5 id="sidebarTitle">Business Example</h5>
        <i class="bi bi-x-lg fs-4" role="button" onclick="toggleSidebar(false)"></i>
    </div>
    <div class="sidebar-body">
        <img th:src="@{/img/logo.png}" th:alt="'Business Logo'" width="250" height="100" class="img-fluid mb-3">
        <p th:if="${business.address != null}">
            <strong>Address:</strong><br>
            <span th:text="${business.address}"></span>
        </p>
        <p th:if="${business.socialLinks != null and !business.socialLinks.isEmpty()}">
            <strong>Follow us:</strong>
        </p>
        <p th:if="${business.socialLinks != null and !business.socialLinks.isEmpty()}">
            <a th:each="link : ${business.socialLinks}"
               th:href="${link.url}" target="_blank"
               class="me-2">
                <i th:class="${'bi ' + (link.type == 'web' ? 'bi-link' : 'bi-' + link.type.toLowerCase()) + ' fs-4'}"></i>
            </a>
        </p>
    </div>
</aside>

<!-- MAIN CONTENT -->
<div class="container py-5">
    <div class="mb-4">
        <select id="catalogSelect" class="form-select" onchange="showCatalogItems()"></select>
    </div>

    <div id="catalogItemsContainer"></div>
</div>

<!-- OFFERING MODAL -->
<div class="modal fade" id="offeringModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="offeringModalTitle" style="color: black">Offering</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="offeringCarousel" class="carousel slide mb-3" data-bs-ride="carousel">
                    <div class="carousel-inner" id="carouselInner"></div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#offeringCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#offeringCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                </div>
                <p id="offeringModalDescription" style="color: black">Description</p>
                <p style="color: black"><strong>Price: </strong><span id="offeringModalPrice">0.00€</span></p>
            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    function toggleSidebar(open) {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('open', open);
    }

    /*<![CDATA[*/
    const businessData = JSON.parse(/*[[${businessJson}]]*/ 'null');
    /*]]>*/

    let currentLanguage = businessData.supportedLanguages[0];

    function initializePage() {
        const langSelect = document.getElementById('languageSelect');
        langSelect.innerHTML = '';
        businessData.supportedLanguages.forEach(lang => {
            const option = document.createElement('option');
            option.value = lang;
            option.textContent = lang;
            langSelect.appendChild(option);
        });
        langSelect.value = currentLanguage;

        document.getElementById('sidebarTitle').textContent = businessData.name;

        showCatalogItems();
    }

    function changeLanguage() {
        currentLanguage = document.getElementById('languageSelect').value;
        showCatalogItems();
    }

    function showCatalogItems() {
        const catalogId = document.getElementById('catalogSelect').value;
        const container = document.getElementById('catalogItemsContainer');
        container.innerHTML = '';

        // atualizar o select de catálogo para a linguagem atual
        const catalogSelect = document.getElementById('catalogSelect');
        catalogSelect.innerHTML = '';
        businessData.catalogs.forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            option.textContent = c.name[currentLanguage]; // aqui pega a linguagem atual
            catalogSelect.appendChild(option);
        });
        catalogSelect.value = catalogId || businessData.catalogs[0].id;

        const catalog = businessData.catalogs.find(c => c.id === catalogSelect.value);
        if (!catalog) return;

        catalog.categories.forEach(category => {
            const catDiv = document.createElement('div');
            catDiv.className = 'mb-4';
            catDiv.innerHTML = `<h4 class="mb-3">${category.name[currentLanguage]}</h4><div class="row g-4"></div>`;
            const row = catDiv.querySelector('div.row');

            category.offerings.forEach(offering => {
                const col = document.createElement('div');
                col.className = 'col-md-4';
                col.innerHTML = `
                <div class="card catalog-card" onclick="openOfferingModal('${offering.id}')">
                    <img src="${offering.images[0]}" class="card-img-top" alt="${offering.name[currentLanguage]}">
                    <div class="card-body">
                        <h5 class="card-title">${offering.name[currentLanguage]}</h5>
                        <p class="card-text">${offering.description[currentLanguage]}</p>
                        <span class="badge bg-primary">${offering.price}</span>
                    </div>
                </div>`;
                row.appendChild(col);
            });

            container.appendChild(catDiv);
        });
    }

    function openOfferingModal(offeringId) {
        const offerings = businessData.catalogs.flatMap(c => c.categories.flatMap(cat => cat.offerings));
        const offering = offerings.find(o => o.id === offeringId);
        if (!offering) return;

        document.getElementById('offeringModalTitle').textContent = offering.name[currentLanguage];
        document.getElementById('offeringModalDescription').textContent = offering.description[currentLanguage];
        document.getElementById('offeringModalPrice').textContent = offering.price;

        const carouselInner = document.getElementById('carouselInner');
        carouselInner.innerHTML = '';
        offering.images.forEach((imgUrl, index) => {
            const div = document.createElement('div');
            div.className = 'carousel-item' + (index === 0 ? ' active' : '');
            div.innerHTML = `<img src="${imgUrl}" class="d-block w-100">`;
            carouselInner.appendChild(div);
        });

        new bootstrap.Modal(document.getElementById('offeringModal')).show();
    }

    window.addEventListener('DOMContentLoaded', initializePage);
</script>
</body>
</html>
