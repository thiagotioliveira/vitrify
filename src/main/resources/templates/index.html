<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title th:text="${business.name}">Business Showcase</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        body {
            background-color: [[${business.backgroundColorSecondary}]];
            color: [[${business.colorSecondary}]];
        }

        .bg-primary {
            background-color: [[${business.backgroundColorPrimary}]] !important;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: [[${business.backgroundColorPrimary}]];
            color: [[${business.colorPrimary}]];
            border-bottom: 1px solid #dee2e6;
        }

        header img {
            max-height: 60px;
            width: auto;
            height: auto;
        }

        .offcanvas {
            background-color: [[${business.backgroundColorPrimary}]];
            color: [[${business.colorPrimary}]];
        }

        .offcanvas i {
            color: [[${business.colorPrimary}]];
        }

        .font-color {
            color: [[${business.colorSecondary}]];
        }

        /* Catalog cards */
        .catalog-card img {
            object-fit: cover;
            width: 100%;
            height: 180px;
        }

        @media (max-width: 576px) {
            .catalog-card img { height: 140px; }
            header img { max-height: 40px; }
        }
    </style>
</head>
<body>

<!-- HEADER -->
<header>
    <img id="businessLogo" th:src="@{/img/logo.png}" th:alt="'Business Logo'">
    <div class="d-flex align-items-center gap-2">
        <select id="languageSelect" class="form-select w-auto" onchange="changeLanguage()"></select>
        <button class="btn btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebar" aria-controls="sidebar">
            <i class="bi bi-list fs-2"></i>
        </button>
    </div>
</header>

<!-- SIDEBAR (OFFCANVAS) -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="sidebar" aria-labelledby="sidebarLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="sidebarLabel" th:text="${business.name}">Business Example</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <img th:src="@{/img/logo.png}" th:alt="'Business Logo'" class="img-fluid mb-3">
        <p th:if="${business.address != null}">
            <strong>Address:</strong><br>
            <span th:text="${business.address}"></span>
        </p>
        <p th:if="${business.socialLinks != null and !business.socialLinks.isEmpty()}">
            <strong>Follow us:</strong>
        </p>
        <div th:if="${business.socialLinks != null and !business.socialLinks.isEmpty()}">
            <a th:each="link : ${business.socialLinks}"
               th:href="${link.url}" target="_blank" class="me-2">
                <i th:class="${'bi ' + (link.type == 'web' ? 'bi-link' : 'bi-' + link.type.toLowerCase()) + ' fs-4'}"></i>
            </a>
        </div>
    </div>
</div>

<!-- MAIN CONTENT -->
<div class="container py-5">
    <div class="mb-4">
        <select id="catalogSelect" class="form-select" onchange="showCatalogItems()"></select>
    </div>
    <div id="catalogItemsContainer" class="row g-4"></div>
</div>

<!-- OFFERING MODAL -->
<div class="modal fade" id="offeringModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content font-color">
            <div class="modal-header">
                <h5 class="modal-title" id="offeringModalTitle">Offering</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="offeringCarousel" class="carousel slide mb-3" data-bs-ride="carousel">
                    <div class="carousel-inner" id="carouselInner"></div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#offeringCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#offeringCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                    </button>
                </div>
                <p id="offeringModalDescription">Description</p>
                <p><strong>Price: </strong><span id="offeringModalPrice">0.00â‚¬</span></p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    const businessData = JSON.parse(/*[[${businessJson}]]*/ 'null');
    let currentLanguage = businessData.supportedLanguages[0];

    function initializePage() {
        const langSelect = document.getElementById('languageSelect');
        langSelect.innerHTML = '';
        businessData.supportedLanguages.forEach(lang => {
            const option = document.createElement('option');
            option.value = lang;
            option.textContent = lang;
            langSelect.appendChild(option);
        });
        langSelect.value = currentLanguage;
        showCatalogItems();
    }

    function changeLanguage() {
        currentLanguage = document.getElementById('languageSelect').value;
        showCatalogItems();
    }

    function showCatalogItems() {
        const catalogId = document.getElementById('catalogSelect').value;
        const container = document.getElementById('catalogItemsContainer');
        container.innerHTML = '';

        const catalogSelect = document.getElementById('catalogSelect');
        catalogSelect.innerHTML = '';
        businessData.catalogs.forEach(c => {
            const option = document.createElement('option');
            option.value = c.id;
            option.textContent = c.name[currentLanguage];
            catalogSelect.appendChild(option);
        });
        catalogSelect.value = catalogId || businessData.catalogs[0].id;

        const catalog = businessData.catalogs.find(c => c.id === catalogSelect.value);
        if (!catalog) return;

        catalog.categories.forEach(category => {
            const catDiv = document.createElement('div');
            catDiv.className = 'mb-4';
            catDiv.innerHTML = `<h4 class="mb-3 font-color">${category.name[currentLanguage]}</h4><div class="row g-4"></div>`;
            const row = catDiv.querySelector('div.row');

            category.offerings.forEach(offering => {
                const col = document.createElement('div');
                col.className = 'col-12 col-sm-6 col-md-4';
                col.innerHTML = `
                    <div class="card catalog-card font-color" onclick="openOfferingModal('${offering.id}')">
                        <img src="${offering.images[0]}" class="card-img-top" alt="${offering.name[currentLanguage]}">
                        <div class="card-body">
                            <h5 class="card-title">${offering.name[currentLanguage]}</h5>
                            <p class="card-text">${offering.description[currentLanguage]}</p>
                            <span class="badge bg-primary">${offering.price}</span>
                        </div>
                    </div>`;
                row.appendChild(col);
            });
            container.appendChild(catDiv);
        });
    }

    function openOfferingModal(offeringId) {
        const offerings = businessData.catalogs.flatMap(c => c.categories.flatMap(cat => cat.offerings));
        const offering = offerings.find(o => o.id === offeringId);
        if (!offering) return;

        document.getElementById('offeringModalTitle').textContent = offering.name[currentLanguage];
        document.getElementById('offeringModalDescription').textContent = offering.description[currentLanguage];
        document.getElementById('offeringModalPrice').textContent = offering.price;

        const carouselInner = document.getElementById('carouselInner');
        carouselInner.innerHTML = '';
        offering.images.forEach((imgUrl, index) => {
            const div = document.createElement('div');
            div.className = 'carousel-item' + (index === 0 ? ' active' : '');
            div.innerHTML = `<img src="${imgUrl}" class="d-block w-100">`;
            carouselInner.appendChild(div);
        });

        new bootstrap.Modal(document.getElementById('offeringModal')).show();
    }

    window.addEventListener('DOMContentLoaded', initializePage);
</script>
</body>
</html>
